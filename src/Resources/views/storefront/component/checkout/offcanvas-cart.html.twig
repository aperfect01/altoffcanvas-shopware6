{# Extend the original template FIRST #}
{% sw_extends '@Storefront/storefront/component/checkout/offcanvas-cart.html.twig' %}

{# Override the main offcanvas block #}
{% block component_offcanvas_cart %}
    {# Detect if this is add-to-cart based on flash message content #}
    {% set isAddToCart = false %}
    {% set addedProductId = null %}
    {% if app.flashes('success') is defined %}
        {% for flash in app.flashes('success') %}
            {% if 'added' in flash|lower or 'hinzugefÃ¼gt' in flash|lower or 'product has been added' in flash|lower %}
                {% set isAddToCart = true %}
            {% endif %}
        {% endfor %}
    {% endif %}
    
    {# Get the added product ID from the subscriber and find the matching line item #}
    {% set addedProductId = page.extensions.addedProductId ? page.extensions.addedProductId.productId : null %}
    {% set newestItem = null %}
    
    {# If we have the correct product ID from subscriber, find the matching line item #}
    {% if addedProductId %}
        {% for lineItem in page.cart.lineItems %}
            {% if lineItem.referencedId == addedProductId %}
                {% set newestItem = lineItem %}
                {% break %}
            {% endif %}
        {% endfor %}
    {% endif %}
    
    {# Fallback to last item if we couldn't find the specific one #}
    {% if not newestItem and page.cart.lineItems|length > 0 %}
        {% set newestItem = page.cart.lineItems|last %}
    {% endif %}
    
{% for crossSelling in page.crossSellings %}
    <div>{{ crossSelling.name }}</div>
{% endfor %}
    {% if isAddToCart %}
        <div class="alert alert-success mb-3">
            <h3 class="h4" style="margin-bottom: 0 !important;">Item Added to Cart</h3>
            
        </div>
        {% if page.cart.lineItems|length > 0 %}
                {# Use the newest item we already found above #}
                {% set lastItem = newestItem %}
                <div class="d-flex align-items-center mb-3 p-3 bg-white">
                    {% if lastItem.cover %}
                        <img src="{{ lastItem.cover.url }}" alt="{{ lastItem.label }}" class="me-3 border rounded" style="width: 80px; height: 80px; object-fit: cover;">
                    {% else %}
                        <div class="me-3 d-flex align-items-center justify-content-center bg-light border rounded" style="width: 80px; height: 80px;">
                            <span class="h4 text-muted">?</span>
                        </div>
                    {% endif %}
                    
                    <div class="flex-fill">
                        <div class="fw-bold mb-1">{{ lastItem.label }}</div>
                        <div class="text-muted mb-1">Quantity: <strong>{{ lastItem.quantity }}</strong></div>
                        <div class="text-primary fw-bold">{{ lastItem.price.totalPrice|currency }}</div>
                    </div>
                </div>
                
            
            {% endif %}
        
        {% if page.extensions.crossSellingProducts and page.extensions.crossSellingProducts.products|length > 0 %}
            <div class="mb-3">
                <h4 class="h5 mb-3 text-primary fw-semibold">
                    You might also like
                </h4>
                <div class="row g-3">
                    {% for product in page.extensions.crossSellingProducts.products %}
                        <div class="col-6">
                            <div class="card h-100 text-center border rounded">
                                <div class="card-body p-2">
                                    <img src="{{ product.cover.media.url }}" alt="{{ product.translated.name }}" 
                                        class="img-fluid mb-2 rounded" style="width: 100px; height: 100px; object-fit: cover;">
                                    
                                    <div class="small fw-semibold mb-1 text-truncate">
                                        {{ product.translated.name }}
                                    </div>
                                    
                                    <div class="text-primary fw-bold small mb-2">
                                        {% if product.calculatedPrice %}
                                            {{ product.calculatedPrice.unitPrice|currency }}
                                        {% elseif product.price %}
                                            {{ product.price.first.gross|currency }}
                                        {% else %}
                                            {{ product.cheapestPrice.price.first.gross|currency }}
                                        {% endif %}
                                    </div>
                                    
                                    <form action="{{ path('frontend.checkout.line-item.add') }}" method="post" class="buy-widget" data-add-to-cart="true">
                                        <input type="hidden" name="lineItems[{{ product.id }}][id]" value="{{ product.id }}">
                                        <input type="hidden" name="lineItems[{{ product.id }}][type]" value="product">
                                        <input type="hidden" name="lineItems[{{ product.id }}][quantity]" value="1">
                                        <input type="hidden" name="redirectTo" value="{{ app.request.get('_route') }}">
                                        <input type="hidden" name="redirectParameters" value="{{ app.request.get('_route_params')|json_encode }}">
                                        <button type="submit" class="btn btn-primary btn-sm w-100">Add to Cart</button>
                                    </form>

                                    
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        
    {% else %}
        {{ parent() }}
    {% endif %}
{% endblock %}